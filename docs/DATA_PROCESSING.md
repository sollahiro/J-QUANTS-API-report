# データ加工フロー説明

J-QUANTS APIから取得したデータがどのように加工されて最終的な分析結果になるか、そのフローを説明します。

## 実行環境

このデータ加工フローは、Streamlitアプリケーション（`app.py`）から呼び出されます。
- **エントリーポイント**: `app.py`（Streamlitアプリケーション）
- **分析実行**: `src/ui/analysis_handler.py`の`run_analysis()`関数
- **分析ロジック**: `src/analysis/individual.py`の`IndividualAnalyzer`クラス

## 全体フロー

```
Streamlitアプリ（app.py）
  ↓
分析ハンドラー（run_analysis）
  ↓
API取得 → 年度データ抽出 → 株価取得 → 指標計算 → レポート生成
  ↓
分析結果の表示（Streamlit UI）
```

## 1. APIから生データ取得

### 1.1 銘柄マスタ情報取得
- **API**: `/equities/master`
- **取得データ**: 銘柄コード、銘柄名（`CoName`）、業種、市場区分など
- **用途**: レポートのヘッダー表示、ログ出力

### 1.2 財務データ取得
- **API**: `/fins/summary`
- **取得データ**: 財務サマリー情報（年度データ、四半期データが混在）
- **データ形式**: 
  - `CurPerType`: 期間タイプ（"FY"=年度、"1Q"、"2Q"、"3Q"、"4Q"=四半期）
  - `CurFYEn`: 年度終了日（YYYYMMDD形式）
  - `DiscDate`: 開示日
  - `Sales`: 売上高（円単位）
  - `OP`: 営業利益（円単位）
  - `NP`: 当期純利益（円単位）
  - `Eq`: 純資産（円単位）
  - `CFO`: 営業CF（円単位）
  - `CFI`: 投資CF（円単位）
  - `EPS`: 1株当たり当期純利益（円）
  - `BPS`: 1株当たり純資産（円）
  - その他

**注意**: APIから取得するデータは**円単位**です（百万円単位ではありません）。

## 2. 年度データ抽出（`extract_annual_data`）

### 2.1 フィルタリング
- **期間タイプ**: `CurPerType == "FY"` のレコードのみを抽出
- **未来の年度データ除外**: 現在日付より未来の年度終了日を持つデータを除外
  - 例: 2025年12月31日時点で、2026年3月31日終了の年度データは除外
- **無効データ除外**: 主要財務データ（売上高、営業利益、当期純利益、純資産）が全て無効（None、NaN、空文字列、0）のレコードを除外

### 2.2 ソート
- **年度終了日（`CurFYEn`）でソート**: 新しい順（降順）
- **開示日（`DiscDate`）でソート**: 同じ年度終了日の場合は新しい開示日を優先

### 2.3 重複除去
- **同じ年度終了日のデータが複数ある場合**:
  - 主要データ（売上高）があるものを優先
  - 同じなら新しい開示日を優先
  - 最新の開示日で主要データがあるものを残す

### 2.4 出力
- **年度データのリスト**: 新しい順にソート済み、重複除去済み、未来の年度は除外済み

## 3. 株価取得

### 3.1 年度末株価の取得
- **API**: `/equities/bars/daily`（日次株価データ）
- **取得タイミング**: 各年度の年度終了日（`CurFYEn`）
- **処理**:
  - 年度終了日が休日の場合は、直前の営業日の終値を取得
  - 日付形式を統一（YYYY-MM-DD形式とYYYYMMDD形式の両方を保存）

### 3.2 株価データの保存
- **辞書形式**: `{年度終了日: 株価}` の形式で保存
- **キー形式**: YYYY-MM-DD形式とYYYYMMDD形式の両方をキーとして保存（柔軟な検索のため）

## 4. 指標計算（`calculate_metrics_flexible`）

### 4.1 データの前処理
- **分析年数の決定**: 利用可能な年数と最大年数（デフォルト10年）の小さい方を使用
- **未来の年度データ除外**: 念のため再度チェック（`extract_annual_data`で既に除外済みだが、二重チェック）
- **無効データ除外**: 主要財務データが全て無効なレコードを除外

### 4.2 基本財務データの数値変換
- **`to_float`関数**: 文字列、数値、Noneを適切にfloat型に変換
- **変換対象**:
  - `Sales`: 売上高（円単位）
  - `OP`: 営業利益（円単位）
  - `NP`: 当期純利益（円単位）
  - `Eq`: 純資産（円単位）
  - `CFO`: 営業CF（円単位）
  - `CFI`: 投資CF（円単位）
  - `EPS`: 1株当たり当期純利益（円）
  - `BPS`: 1株当たり純資産（円）

**重要**: この時点では**単位変換は行いません**。APIから取得した円単位のまま保持します。

### 4.3 計算指標の算出

#### 4.3.1 FCF（フリーキャッシュフロー）
```
FCF = 営業CF + 投資CF
```
- `CFO`（営業CF）と`CFI`（投資CF）の合計
- 両方が有効な場合のみ計算

#### 4.3.2 ROE（自己資本利益率）
```
ROE = (当期純利益 / 純資産) × 100
```
- パーセント表示
- 純資産が0の場合は計算不可（None）

#### 4.3.3 PER（株価収益率）
```
PER = 株価 / EPS
```
- EPSが0以下の場合は計算不可（None）

#### 4.3.4 PBR（株価純資産倍率）
```
PBR = 株価 / BPS
```
- BPSが0以下の場合は計算不可（None）

### 4.4 成長率の計算

#### 4.4.1 データ年数に応じた自動選択
- **2年データ**: 前年比成長率（Year-over-Year）
- **3年以上データ**: CAGR（年平均成長率）

#### 4.4.2 前年比成長率（YoY）
```
成長率 = ((最新年の値 / 前年の値) - 1) × 100
```

#### 4.4.3 CAGR（年平均成長率）
```
CAGR = ((最新年の値 / 最古の値) ^ (1 / 年数) - 1) × 100
```
- 年数は期間年数（例: 5年分のデータなら4年）

#### 4.4.4 計算対象指標
- FCF成長率
- ROE成長率
- EPS成長率
- 売上高成長率
- PER成長率
- PBR成長率

### 4.5 出力データ構造
```python
{
    "code": 銘柄コード,
    "latest_fy_end": 最新年度終了日,
    "analysis_years": 分析年数,
    "available_years": 利用可能年数,
    "years": [
        {
            "fy_end": 年度終了日,
            "sales": 売上高（円単位）,
            "op": 営業利益（円単位）,
            "np": 当期純利益（円単位）,
            "eq": 純資産（円単位）,
            "cfo": 営業CF（円単位）,
            "cfi": 投資CF（円単位）,
            "fcf": FCF（円単位）,
            "roe": ROE（%),
            "eps": EPS（円）,
            "bps": BPS（円）,
            "price": 株価（円）,
            "per": PER（倍）,
            "pbr": PBR（倍）,
        },
        ...
    ],
    "fcf_growth": FCF成長率（%）,
    "roe_growth": ROE成長率（%）,
    "eps_growth": EPS成長率（%）,
    "sales_growth": 売上高成長率（%）,
    "per_growth": PER成長率（%）,
    "pbr_growth": PBR成長率（%）,
    "fcf_cagr": FCF CAGR（3年以上の場合のみ）,
    "roe_cagr": ROE CAGR（3年以上の場合のみ）,
    "eps_cagr": EPS CAGR（3年以上の場合のみ）,
    "sales_cagr": 売上高CAGR（3年以上の場合のみ）,
    "per_cagr": PER CAGR（3年以上の場合のみ）,
    "pbr_cagr": PBR CAGR（3年以上の場合のみ）,
    ...
}
```

## 5. Streamlit UIでの表示と単位変換

### 5.1 Streamlit UIでの表示
- **表示コンポーネント**: `src/ui/components.py`の`display_analysis_results()`関数
- **年度別財務データ表**: `src/ui/table.py`の`create_financial_data_table()`関数で生成
- **グラフ表示**: Plotlyグラフをタブ形式で表示
- **有報PDFダウンロード**: 最新年度の有価証券報告書PDFをダウンロード可能

### 5.4 年度別財務データ表
- **`format_currency`フィルター**: 数値を百万円単位で表示
- **変換ロジック**: 
  - 値が0の場合は"0"を表示
  - 値が0でない場合: `abs(値) / 1,000,000` を計算して百万円単位で表示
  - 負の値の場合は"-"を付与

### 5.3 グラフのホバー表示
- **FCF推移、売上高推移**: `customdata`を使用して百万円単位で表示
- **変換ロジック**: グラフの`y`値は円単位のまま、ホバー表示時に`customdata`（百万円単位）を表示

### 5.4 グラフのY軸
- **FCF推移**: "金額 (円)" と表示（実際の値は円単位）

---


## 6. Streamlit UIでの表示

### 6.1 分析結果の表示
- **表示関数**: `src/ui/components.py`の`display_analysis_results()`関数
- **レイアウト**: 左右2カラム（左：事業概要、右：財務グラフ）
- **年度別財務データ表**: 年度列固定、横スクロール対応、ダークモード対応

### 6.2 グラフの表示
- **グラフ生成**: `src/report/graph_generator.py`の`_create_interactive_graphs()`メソッド
- **表示形式**: Plotlyグラフをタブ形式で表示
- **グラフセクション**:
  - 事業効率（簡易ROIC × CF変換率）
  - キャッシュフロー（FCF）
  - 株主価値の蓄積（EPS × BPS × ROE）
  - 配当政策と市場評価（配当性向 × ROE × PBR）
  - 市場評価（PER × ROE × PBR）
  - 株価とEPSの乖離

### 6.3 有報PDFダウンロード
- **PDF保存先**: `reports/{code}_edinet/`ディレクトリ
- **ダウンロード機能**: Streamlitの`st.download_button()`を使用
- **表示条件**: 最新年度の有価証券報告書PDFが存在する場合のみ表示

## 7. EDINET統合機能の処理フロー（XBRL解析）

### 7.1 EDINET APIから有価証券報告書を取得
- **API**: EDINET APIの`/documents/{docID}`エンドポイント
- **取得データ**: PDFファイルとXBRLファイル（ZIP形式）
- **保存先**: `reports/{code}_edinet/`ディレクトリ
  - PDF: `{docID}.pdf`
  - XBRL: `{docID}_xbrl/`ディレクトリに展開

### 7.2 XBRL解析
- **解析モジュール**: `src/analysis/xbrl_parser.py`の`XBRLParser`クラス
- **処理内容**:
  1. **インラインXBRL（HTML形式）の解析**:
     - `beautifulsoup4`を使用してHTMLからセクションを抽出
     - `PublicDoc/`ディレクトリ内のHTMLファイルを検索
  2. **XBRLインスタンス文書（XML形式）の解析**:
     - `xml.etree.ElementTree`を使用してXMLからテキストブロックを抽出
     - `XBRL/`ディレクトリ内のXMLファイルを検索
  3. **報告書タイプの自動判定**:
     - ファイル名やXML内容から有価証券報告書と半期報告書を自動判定
  4. **セクション抽出**（`COMMON_SECTIONS`で定義）:
     - **A: 事業の内容** (`DescriptionOfBusinessTextBlock`)
       - 会社の事業内容、主要製品・サービス、事業の特徴など
     - **B: 経営方針、経営環境及び対処すべき課題等** (`BusinessPolicyTextBlock`)
       - 経営方針、経営環境の変化、対処すべき課題、事業戦略など
     - **C: 事業等のリスク** (`BusinessRisksTextBlock`)
       - 事業リスク、財務リスク、経営リスク、リスク対策など
     - **D: 経営者による財政状態、経営成績及びキャッシュ・フローの状況の分析** (`ManagementAnalysisOfFinancialPositionOperatingResultsAndCashFlowsTextBlock`)
       - 経営成績の分析、財政状態の分析、キャッシュ・フロー状況の分析など
     - **E: 重要な契約等** (`ImportantContractsTextBlock`)
       - 重要な契約、取引先との関係、関連会社との取引など
     - **F: 設備投資等の概要** (`OverviewOfCapitalInvestmentTextBlock`)
       - 設備投資計画、研究開発投資、M&A計画など
     - **抽出順序**: A→B→C→D→E→Fの順で抽出し、結合してLLMに渡す

### 7.3 LLM要約
- **要約モジュール**: `src/analysis/llm_summarizer.py`の`LLMSummarizer`クラス
- **処理内容**:
  1. XBRLから抽出したテキストを結合
  2. Ollama（`gemma3:1b`モデル、デフォルト）を使用してテキストを要約。環境変数`LLM_MODEL`で他のモデルに切り替え可能
  3. 日本語出力を強制し、マークダウン記法で出力
  4. 要約結果をキャッシュ（`cache/edinet/summaries/`に保存）

### 7.4 Streamlit UIでの表示
- **表示コンポーネント**: `src/ui/components.py`の`_display_business_overview()`関数
- **表示内容**:
  - 最新年度の有価証券報告書から抽出した事業概要・経営方針・課題のLLM要約
  - マークダウン記法対応（見出し、箇条書き、強調表示）
  - 年度と提出日を表示
  - 有報PDFダウンロードボタンを表示

### 7.5 PDFとXBRLの使い分け
- **PDF**: ダウンロード用のみ（ユーザーが手動で確認するためのファイル）
- **XBRL**: 要約用（LLM要約のためのテキスト抽出に使用）

## データの単位について

### APIから取得するデータ
- **単位**: 円単位（百万円単位ではない）
- **例**: 売上高が1,000,000,000円の場合、APIからは`1000000000`として取得される

### 内部処理でのデータ保持
- **単位**: 円単位のまま保持
- **理由**: 単位変換は表示時のみ行うことで、計算の精度を保つ

### 表示時の単位変換
- **年度別財務データ表**: 百万円単位で表示（`format_currency`フィルター）
- **グラフのホバー**: 百万円単位で表示（`customdata`を使用）
- **グラフのY軸**: 円単位で表示（実際の値は円単位）

## データの検証と除外

### 除外されるデータ
1. **未来の年度データ**: 現在日付より未来の年度終了日を持つデータ
2. **無効データ**: 主要財務データ（売上高、営業利益、当期純利益、純資産）が全て無効（None、NaN、空文字列、0）のレコード
3. **重複データ**: 同じ年度終了日のデータが複数ある場合、最新の開示日で主要データがあるものを残す

### データの有効性チェック
- **`is_valid_value`関数**: 値が有効かどうかをチェック
  - None、空文字列、NaN、0は無効と判定
  - 数値に変換可能で、0でない値のみ有効と判定

## 計算エラーの処理

### エラーが発生する場合
- **除算エラー**: 分母が0の場合、計算結果は`None`になる
- **型変換エラー**: 文字列を数値に変換できない場合、`None`になる
- **None値の伝播**: 計算に必要な値が`None`の場合、計算結果も`None`になる

### エラー時の動作
- **計算不可**: 計算結果は`None`として保存
- **表示**: `None`の場合は"N/A"として表示
- **グラフ**: `None`値は除外してグラフを描画（データポイントが繋がらない）

## データフローのまとめ

```
1. Streamlitアプリ（app.py）
   ↓
   [ユーザーが銘柄コードを入力して「分析」ボタンをクリック]

2. 分析ハンドラー（run_analysis）
   ↓
   [進捗表示の管理、エラーハンドリング]

3. API取得
   ↓
   [生データ: 円単位、年度/四半期混在、重複あり、未来データ含む]

4. 年度データ抽出（extract_annual_data）
   ↓
   [年度データのみ、未来データ除外、無効データ除外、重複除去、新しい順ソート]

5. 株価取得
   ↓
   [年度終了日ごとの株価（休日は直前営業日）]

6. 指標計算（calculate_metrics_flexible）
   ↓
   [各年度の指標（FCF、ROE、EPS、PER、PBR等）、成長率（YoY/CAGR）]

7. グラフ生成（`src/report/graph_generator.py`）
   ↓
   [Plotlyグラフの生成]

8. グラフ生成（`src/report/graph_generator.py`）
   ↓
   [Plotlyグラフの生成]

9. EDINET統合機能（オプション）
   ↓
   [EDINET APIから有価証券報告書を取得（PDFとXBRL）]
   ↓
   [XBRL解析（`src/analysis/xbrl_parser.py`）でテキスト抽出]
   ↓
   [LLM要約（`src/analysis/llm_summarizer.py`）で要約生成]

10. Streamlit UI表示（`src/ui/components.py`）
   ↓
   [分析結果をWebインターフェースで表示（年度別財務データ表、グラフ、有報要約）]
```

## 重要なポイント

1. **単位変換は表示時のみ**: 内部処理では円単位のまま保持し、表示時に百万円単位に変換
2. **未来データの除外**: 現在日付より未来の年度データは自動的に除外
3. **重複除去**: 同じ年度終了日のデータが複数ある場合、最新の開示日で主要データがあるものを優先
4. **無効データの除外**: 主要財務データが全て無効なレコードは除外
5. **エラーハンドリング**: 計算エラーが発生した場合、`None`として保存し、表示時は"N/A"として表示

