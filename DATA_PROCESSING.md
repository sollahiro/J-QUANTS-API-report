# データ加工フロー説明

J-QUANTS APIから取得したデータがどのように加工されて最終的な分析結果になるか、そのフローを説明します。

## 全体フロー

```
API取得 → 年度データ抽出 → 株価取得 → 指標計算 → レポート生成
```

## 1. APIから生データ取得

### 1.1 銘柄マスタ情報取得
- **API**: `/equities/master`
- **取得データ**: 銘柄コード、銘柄名（`CoName`）、業種、市場区分など
- **用途**: レポートのヘッダー表示、ログ出力

### 1.2 財務データ取得
- **API**: `/fins/summary`
- **取得データ**: 財務サマリー情報（年度データ、四半期データが混在）
- **データ形式**: 
  - `CurPerType`: 期間タイプ（"FY"=年度、"1Q"、"2Q"、"3Q"、"4Q"=四半期）
  - `CurFYEn`: 年度終了日（YYYYMMDD形式）
  - `DiscDate`: 開示日
  - `Sales`: 売上高（円単位）
  - `OP`: 営業利益（円単位）
  - `NP`: 当期純利益（円単位）
  - `Eq`: 純資産（円単位）
  - `CFO`: 営業CF（円単位）
  - `CFI`: 投資CF（円単位）
  - `EPS`: 1株当たり当期純利益（円）
  - `BPS`: 1株当たり純資産（円）
  - その他

**注意**: APIから取得するデータは**円単位**です（百万円単位ではありません）。

## 2. 年度データ抽出（`extract_annual_data`）

### 2.1 フィルタリング
- **期間タイプ**: `CurPerType == "FY"` のレコードのみを抽出
- **未来の年度データ除外**: 現在日付より未来の年度終了日を持つデータを除外
  - 例: 2025年12月31日時点で、2026年3月31日終了の年度データは除外
- **無効データ除外**: 主要財務データ（売上高、営業利益、当期純利益、純資産）が全て無効（None、NaN、空文字列、0）のレコードを除外

### 2.2 ソート
- **年度終了日（`CurFYEn`）でソート**: 新しい順（降順）
- **開示日（`DiscDate`）でソート**: 同じ年度終了日の場合は新しい開示日を優先

### 2.3 重複除去
- **同じ年度終了日のデータが複数ある場合**:
  - 主要データ（売上高）があるものを優先
  - 同じなら新しい開示日を優先
  - 最新の開示日で主要データがあるものを残す

### 2.4 出力
- **年度データのリスト**: 新しい順にソート済み、重複除去済み、未来の年度は除外済み

## 3. 株価取得

### 3.1 年度末株価の取得
- **API**: `/equities/bars/daily`（日次株価データ）
- **取得タイミング**: 各年度の年度終了日（`CurFYEn`）
- **処理**:
  - 年度終了日が休日の場合は、直前の営業日の終値を取得
  - 日付形式を統一（YYYY-MM-DD形式とYYYYMMDD形式の両方を保存）

### 3.2 株価データの保存
- **辞書形式**: `{年度終了日: 株価}` の形式で保存
- **キー形式**: YYYY-MM-DD形式とYYYYMMDD形式の両方をキーとして保存（柔軟な検索のため）

## 4. 指標計算（`calculate_metrics_flexible`）

### 4.1 データの前処理
- **分析年数の決定**: 利用可能な年数と最大年数（デフォルト10年）の小さい方を使用
- **未来の年度データ除外**: 念のため再度チェック（`extract_annual_data`で既に除外済みだが、二重チェック）
- **無効データ除外**: 主要財務データが全て無効なレコードを除外

### 4.2 基本財務データの数値変換
- **`to_float`関数**: 文字列、数値、Noneを適切にfloat型に変換
- **変換対象**:
  - `Sales`: 売上高（円単位）
  - `OP`: 営業利益（円単位）
  - `NP`: 当期純利益（円単位）
  - `Eq`: 純資産（円単位）
  - `CFO`: 営業CF（円単位）
  - `CFI`: 投資CF（円単位）
  - `EPS`: 1株当たり当期純利益（円）
  - `BPS`: 1株当たり純資産（円）

**重要**: この時点では**単位変換は行いません**。APIから取得した円単位のまま保持します。

### 4.3 計算指標の算出

#### 4.3.1 FCF（フリーキャッシュフロー）
```
FCF = 営業CF + 投資CF
```
- `CFO`（営業CF）と`CFI`（投資CF）の合計
- 両方が有効な場合のみ計算

#### 4.3.2 ROE（自己資本利益率）
```
ROE = (当期純利益 / 純資産) × 100
```
- パーセント表示
- 純資産が0の場合は計算不可（None）

#### 4.3.3 PER（株価収益率）
```
PER = 株価 / EPS
```
- EPSが0以下の場合は計算不可（None）

#### 4.3.4 PBR（株価純資産倍率）
```
PBR = 株価 / BPS
```
- BPSが0以下の場合は計算不可（None）

### 4.4 成長率の計算

#### 4.4.1 データ年数に応じた自動選択
- **2年データ**: 前年比成長率（Year-over-Year）
- **3年以上データ**: CAGR（年平均成長率）

#### 4.4.2 前年比成長率（YoY）
```
成長率 = ((最新年の値 / 前年の値) - 1) × 100
```

#### 4.4.3 CAGR（年平均成長率）
```
CAGR = ((最新年の値 / 最古の値) ^ (1 / 年数) - 1) × 100
```
- 年数は期間年数（例: 5年分のデータなら4年）

#### 4.4.4 計算対象指標
- FCF成長率
- ROE成長率
- EPS成長率
- 売上高成長率
- PER成長率
- PBR成長率

### 4.5 出力データ構造
```python
{
    "code": 銘柄コード,
    "latest_fy_end": 最新年度終了日,
    "analysis_years": 分析年数,
    "available_years": 利用可能年数,
    "years": [
        {
            "fy_end": 年度終了日,
            "sales": 売上高（円単位）,
            "op": 営業利益（円単位）,
            "np": 当期純利益（円単位）,
            "eq": 純資産（円単位）,
            "cfo": 営業CF（円単位）,
            "cfi": 投資CF（円単位）,
            "fcf": FCF（円単位）,
            "roe": ROE（%),
            "eps": EPS（円）,
            "bps": BPS（円）,
            "price": 株価（円）,
            "per": PER（倍）,
            "pbr": PBR（倍）,
        },
        ...
    ],
    "fcf_growth": FCF成長率（%）,
    "roe_growth": ROE成長率（%）,
    "eps_growth": EPS成長率（%）,
    "sales_growth": 売上高成長率（%）,
    "per_growth": PER成長率（%）,
    "pbr_growth": PBR成長率（%）,
    "fcf_cagr": FCF CAGR（3年以上の場合のみ）,
    "roe_cagr": ROE CAGR（3年以上の場合のみ）,
    "eps_cagr": EPS CAGR（3年以上の場合のみ）,
    "sales_cagr": 売上高CAGR（3年以上の場合のみ）,
    "per_cagr": PER CAGR（3年以上の場合のみ）,
    "pbr_cagr": PBR CAGR（3年以上の場合のみ）,
    ...
}
```

## 5. レポート生成時の単位変換

### 5.1 年度別財務データ表
- **`format_currency`フィルター**: 数値を百万円単位で表示
- **変換ロジック**: 
  - 値が0の場合は"0"を表示
  - 値が0でない場合: `abs(値) / 1,000,000` を計算して百万円単位で表示
  - 負の値の場合は"-"を付与

### 5.2 グラフのホバー表示
- **FCF推移、売上高推移**: `customdata`を使用して百万円単位で表示
- **変換ロジック**: グラフの`y`値は円単位のまま、ホバー表示時に`customdata`（百万円単位）を表示

### 5.3 グラフのY軸
- **FCF推移**: "金額 (円)" と表示（実際の値は円単位）

---

## 6. CSVレポート出力

### 6.1 CSVレポートの構成

HTMLレポート生成時に、同じデータをCSV形式でも自動出力します。

**出力内容**:
1. **ヘッダー情報**（セクション名なし）
   - 項目、値の2列形式
   - 銘柄コード、会社名、セクター名、市場名、分析日

2. **年度別財務データ**（セクション名なし）
   - 19列のテーブル形式
   - ヘッダー行 + データ行（各年度1行）

### 6.2 CSV出力データの詳細

**基本財務指標**（14列）:
- 年度終了日
- 売上高(百万円)
- 営業利益(百万円)
- 当期純利益(百万円)
- 純資産(百万円)
- 営業CF(百万円)
- 投資CF(百万円)
- FCF(百万円)
- ROE(%)
- EPS(円)
- BPS(円)
- PER(倍)
- PBR(倍)
- 配当性向(%)

**グラフ用計算指標**（5列）:
- 簡易ROIC(%) = 営業利益 / 純資産 × 100
- CF変換率(%) = 営業CF / 営業利益 × 100
- 株価(円) = 年度末終値（既存データを使用）
- 株価指数 = (現在株価 / 基準年度株価) × 100（基準年度=100）
- EPS指数 = (現在EPS / 基準年度EPS) × 100（基準年度=100）

### 6.3 データフォーマット

- **金額データ**: 円単位のデータを百万円単位に変換（小数点2桁）
- **比率データ**: パーセント表示（小数点2桁）
- **倍率データ**: 倍表示（小数点2桁）
- **指数データ**: 基準年度=100として計算（小数点2桁）
- **空値**: Noneの場合は空文字列として出力

### 6.4 ファイル形式

- **エンコーディング**: UTF-8 with BOM (`utf-8-sig`) - Excelで正しく開けるように
- **ファイル名**: `visual_report_{銘柄コード}_{タイムスタンプ}.csv`
- **出力先**: `reports/`ディレクトリ（HTMLレポートと同じディレクトリ）
- **売上高推移**: "売上高 (円)" と表示（実際の値は円単位）

## データの単位について

### APIから取得するデータ
- **単位**: 円単位（百万円単位ではない）
- **例**: 売上高が1,000,000,000円の場合、APIからは`1000000000`として取得される

### 内部処理でのデータ保持
- **単位**: 円単位のまま保持
- **理由**: 単位変換は表示時のみ行うことで、計算の精度を保つ

### 表示時の単位変換
- **年度別財務データ表**: 百万円単位で表示（`format_currency`フィルター）
- **グラフのホバー**: 百万円単位で表示（`customdata`を使用）
- **グラフのY軸**: 円単位で表示（実際の値は円単位）

## データの検証と除外

### 除外されるデータ
1. **未来の年度データ**: 現在日付より未来の年度終了日を持つデータ
2. **無効データ**: 主要財務データ（売上高、営業利益、当期純利益、純資産）が全て無効（None、NaN、空文字列、0）のレコード
3. **重複データ**: 同じ年度終了日のデータが複数ある場合、最新の開示日で主要データがあるものを残す

### データの有効性チェック
- **`is_valid_value`関数**: 値が有効かどうかをチェック
  - None、空文字列、NaN、0は無効と判定
  - 数値に変換可能で、0でない値のみ有効と判定

## 計算エラーの処理

### エラーが発生する場合
- **除算エラー**: 分母が0の場合、計算結果は`None`になる
- **型変換エラー**: 文字列を数値に変換できない場合、`None`になる
- **None値の伝播**: 計算に必要な値が`None`の場合、計算結果も`None`になる

### エラー時の動作
- **計算不可**: 計算結果は`None`として保存
- **表示**: `None`の場合は"N/A"として表示
- **グラフ**: `None`値は除外してグラフを描画（データポイントが繋がらない）

## データフローのまとめ

```
1. API取得
   ↓
   [生データ: 円単位、年度/四半期混在、重複あり、未来データ含む]

2. 年度データ抽出（extract_annual_data）
   ↓
   [年度データのみ、未来データ除外、無効データ除外、重複除去、新しい順ソート]

3. 株価取得
   ↓
   [年度終了日ごとの株価（休日は直前営業日）]

4. 指標計算（calculate_metrics_flexible）
   ↓
   [各年度の指標（FCF、ROE、EPS、PER、PBR等）、成長率（YoY/CAGR）]

5. レポート生成
   ↓
   [表示時のみ単位変換（百万円単位）、グラフ生成、HTML出力]
```

## 重要なポイント

1. **単位変換は表示時のみ**: 内部処理では円単位のまま保持し、表示時に百万円単位に変換
2. **未来データの除外**: 現在日付より未来の年度データは自動的に除外
3. **重複除去**: 同じ年度終了日のデータが複数ある場合、最新の開示日で主要データがあるものを優先
4. **無効データの除外**: 主要財務データが全て無効なレコードは除外
5. **エラーハンドリング**: 計算エラーが発生した場合、`None`として保存し、表示時は"N/A"として表示

