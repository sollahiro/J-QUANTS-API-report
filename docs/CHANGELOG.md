# 更新履歴

## 2026-01-11

- **LLMデフォルトモデルの変更**
  - デフォルトモデルを`qwen3:8b`から`gemma3:1b`に変更（軽量で高速なモデル）
  - 環境変数`LLM_MODEL`でモデルを変更可能であることをドキュメントに明記
  - `.env`ファイルに`LLM_MODEL=モデル名`を設定することで、使用するモデルを切り替え可能

- **PDF解析モジュールを削除**
  - `src/analysis/pdf_parser.py`を削除（使用されていないため）
  - `src/analysis/individual.py`から`PDFParser`のインポートと初期化を削除
  - `requirements.txt`から`pdfplumber`を削除
  - `beautifulsoup4`を`requirements.txt`に追加（XBRL解析用）

- **XBRL解析機能を追加**
  - 有価証券報告書の要約にXBRL解析を使用するように変更
  - `src/analysis/xbrl_parser.py`を追加（XBRL解析モジュール）
  - インラインXBRL（HTML形式）とXBRLインスタンス文書（XML形式）の両方に対応
  - `beautifulsoup4`を使用してHTMLからセクションを抽出
  - `xml.etree.ElementTree`を使用してXMLからテキストブロックを抽出
  - 抽出対象セクション:
    - 事業の内容
    - 経営方針、経営環境及び対処すべき課題等
    - 事業等のリスク
    - 経営者による財政状態、経営成績及びキャッシュ・フローの状況の分析
    - 重要な契約等
    - 設備投資等の概要
  - 報告書タイプの自動判定（有価証券報告書と半期報告書）
  - PDF解析からXBRL解析への移行（PDFはダウンロード用のみ、要約にはXBRLを使用）
  - EDINET APIからXBRLファイル（ZIP形式）をダウンロードし、自動的に展開
  - XBRLファイルは`reports/{code}_edinet/{docID}_xbrl/`ディレクトリに保存

- **Streamlit UIの改善（XBRL解析対応）**
  - 有価証券報告書の要約表示をXBRL解析結果に対応
  - 進捗表示にXBRL解析ステップを追加（「XBRLを解析中」メッセージ）
  - LLM要約時の進捗表示に使用モデル名を表示（例: 「gemma3:1bで分析中」）
  - 有価証券報告書の要約セクションに年度と提出日を表示

- **サイドバー機能の実装**
  - サイドバーにロゴ（📊 Educe）を表示
  - 銘柄コード入力フィールド（プレースホルダー付き）
  - 分析ボタン（プライマリボタンスタイル）
  - 分析履歴セクション（過去に分析した銘柄の一覧表示）

- **分析履歴機能の実装**
  - キャッシュから分析結果を自動読み込み（アプリ起動時）
  - 分析実行時に履歴に自動保存（銘柄コード、会社名、タイムスタンプ、分析結果）
  - 履歴を銘柄コード順（昇順）でソートして表示
  - 履歴項目に銘柄コードと会社名を表示（例: "6501 日立製作所"）
  - 履歴をクリックすると過去の分析結果を即座に表示（再分析不要）
  - 同じ銘柄コードで再分析した場合は履歴を更新
  - セッション状態で履歴を管理（ページリロード時も保持）

## 2026-01-10

- **コード品質と保守性の向上**
  - 設定管理の統一化：環境変数の直接読み込みを削除し、`src/config.py`経由に統一
  - 型ヒントの追加・改善：すべての関数とメソッドに型ヒントを付与
  - docstringの統一：Google形式のdocstringに統一
  - 不要なインポートの削除：使用していない`os`モジュールのインポートを削除
  - ARCHITECTURE.mdの更新：コード品質と設計原則のセクションを追加、UIモジュールの説明を追加

- **ウォッチリスト機能の廃止**
  - `src/utils/watchlist.py`を削除
  - `scripts/watchlist_manager.py`を削除
  - ウォッチリスト関連のコードを`src/analysis/individual.py`と`src/ui/analysis_handler.py`から削除
  - ドキュメントからウォッチリスト関連の記述を削除（ARCHITECTURE.md、README.md、QUICKSTART.md）

- **Streamlitアプリケーションの導入**
  - StreamlitベースのWebインターフェースを実装（`app.py`）
  - UIコンポーネントのモジュール化（`src/ui/`ディレクトリ）
    - `components.py`: 分析結果の表示コンポーネント
    - `sidebar.py`: サイドバーUI（銘柄コード入力、分析ボタン、履歴表示）
    - `table.py`: 年度別財務データテーブルの生成
    - `styles.py`: カスタムCSSスタイル定義
    - `analysis_handler.py`: 分析実行と進捗管理
  - 左右2カラムレイアウト（左：事業概要・要約、右：財務グラフ）
  - 年度別財務データテーブルの表示（年度列固定、横スクロール対応）
  - 有価証券報告書の要約表示（マークダウン記法対応、見出し、箇条書き、強調表示）
  - 有報PDFダウンロード機能（最新年度の有価証券報告書PDFをダウンロード可能）
  - 分析進捗表示機能

- **notebooksディレクトリの廃止**
  - `ARCHITECTURE.md`からnotebooksディレクトリの記述を削除
  - `src/ui/sidebar.py`から`notebooks/cache`への参照を削除
  - `src/analysis/individual.py`から検証用notebookへの言及を削除

- **HTMLレポート・CSVレポート機能の廃止**
  - HTMLレポートファイル生成機能を削除（Streamlit UIで直接表示に変更）
  - CSVレポートファイル生成機能を削除
  - `templates/report_template.html`と`static/css/report.css`は未使用（将来の拡張用に残存）
  - `src/report/html_report.py`を`src/report/graph_generator.py`にリネーム
  - `HTMLReportGenerator`クラスを`GraphGenerator`クラスにリネーム
  - ドキュメントからHTMLレポート・CSVレポート関連の記述を削除（README.md、ARCHITECTURE.md、QUICKSTART.md）

- **総合評価機能の廃止**
  - 総合評価計算関数を削除（`calculate_cagr`, `get_sign`, `evaluate_business_efficiency_pattern`, `evaluate_shareholder_value_pattern`, `evaluate_dividend_policy_pattern`, `evaluate_market_valuation_pattern`）
  - `app.py`から総合評価関数のインポートを削除
  - LLMプロンプトから「レポート形式」の記述を削除（`src/analysis/llm_summarizer.py`）
  - ドキュメントから総合評価機能の記述を削除（README.md、ARCHITECTURE.md、DATA_PROCESSING.md）

## 2026-01-07

- **EDINET統合機能を追加（定性情報分析）**
  - 有価証券報告書から最新年度の事業概要・経営方針・課題を自動取得・要約
  - PDF解析機能を追加（`pdfplumber`を使用、後にXBRL解析に移行）
  - LLM要約機能を追加（Ollama `qwen3:8b`モデルを使用、後に`gemma3:1b`に変更）
  - マークダウン記法対応（見出し、箇条書き、強調表示）
  - HTMLレポートに「最新の事業概要・経営方針・課題」セクションを追加
  - CSVレポートに「事業概要・経営方針・課題要約」列を追加
  - 有報PDFを`reports/{code}_edinet/`に保存
  - LLM要約結果を`cache/edinet/summaries/`にキャッシュ

- **年度別財務データ表の改善**
  - 「年度」列を追加（年度終了日から年度を自動計算）
  - グラフの年度軸を年度ベースに変更（古い年度から新しい年度の順）

- **HTMLレポートの改善**
  - マークダウン記法のHTML変換機能を追加（見出し、箇条書き、強調表示）
  - 数字付き箇条書き（`ol`）と通常の箇条書き（`ul`）のネスト構造に対応

## 2026-01-05

- **CSVレポート出力機能を追加**
  - HTMLレポート生成時に、同じデータをCSV形式でも自動出力
  - 純粋なデータのみを出力（グラフ評価情報は含まない）
  - ヘッダー情報（銘柄コード、会社名、セクター名、市場名、分析日）
  - 年度別財務データ（19列：基本財務指標 + グラフ用計算指標）
    - 基本財務指標: 年度終了日、売上高、営業利益、当期純利益、純資産、営業CF、投資CF、FCF、ROE、EPS、BPS、PER、PBR、配当性向
    - グラフ用計算指標: 簡易ROIC、CF変換率、株価、株価指数、EPS指数
  - ファイル名: `visual_report_{銘柄コード}_{タイムスタンプ}.csv`

- **株主価値の蓄積パターン評価を5類型に更新**

## 2026-01-04

- **コード整理と不要機能の削除**
  - 不要なスクリプトを削除（debug_api.py, check_latest_fy.py, show_roe_bps_eps_patterns.py, analyze_stock.py）
  - analyze_from_watchlistメソッドを削除（スクリーニング機能の残骸）
  - スクリーニング機能の削除と個別分析をメイン機能に
  - スクリーニング機能（パターンA）を削除
  - 個別詳細分析（パターンB）をメイン機能として再構成
  - scripts/analyze_stock.pyをメインエントリーポイントとして強化

## 2026-01-02

- **PER/PBR/ROE推移のパターンマッピング更新**
  - パターン名、評価、評価コメントを更新
  - 評価コメントを評価に応じて色付きで表示（ROE/EPS/BPS推移と同様）

- **四半期別機能の削除**
  - 四半期別財務データの表を削除
  - 四半期別グラフ（財務グラフ（トレンド分析））を削除
  - 年度別データのみに統一

- **HTMLレポートの改善**
  - セクションタイトルとグラフタイトルの分離表示
  - グラフごとのセクション区分け（白背景ボックス）
  - 総合評価のレイアウト改善（CAGR左側、パターンマッピング右側の白背景ボックス）
  - ページ分割の廃止（連続表示）
  - セクションタイトル・グラフタイトル・グラフの間隔を最適化

## 2026-01-01

- **総合評価機能を追加**
  - ROE/EPS/BPS推移とPER/PBR/ROE推移のグラフ下にCAGRに基づく8パターン評価を表示

- **株価 vs EPS指数化比較を追加**
  - 一番古い年を基準（100）として指数化

- **PER推移 vs EPS年次成長率グラフを追加（期待と実績の比較）**

- **HTMLレポートからメトリクスカードを削除、グラフと総合評価に焦点を当てた構成に変更**

- **レポート形式表示からアラート処理を削除**

- **HTMLレポートのヘッダーから適格判定を削除、業種・市場区分・取得年月を2段目に表示**

- **PDF生成機能を削除し、HTMLレポートのみに統一**

- **グラフレイアウトを全て1列表示に変更**

- **未来の年度データ除外**
  - 現在日付より未来の年度データを自動除外

- **分析年数の拡張**
  - 最大10年分のデータを分析可能（利用可能なデータを最大限使用）