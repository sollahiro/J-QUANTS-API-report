<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ code }} {{ name }} - 財務分析レポート</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        {{ css_content }}
    </style>
</head>
<body>
    <!-- Page 1: エグゼクティブサマリー -->
    <div class="page page-1">
        <!-- ヘッダー -->
        <div class="header">
            <div class="header-main">
                <h1 class="company-name">{{ code }} {{ name }}</h1>
                <div class="header-meta">
                    <span class="sector">{{ sector_name }}</span>
                    <span class="market">{{ market_name }}</span>
                    <span class="date">{{ analysis_date }}</span>
                </div>
            </div>
        </div>

        <!-- 最新の事業概要・経営方針・課題セクション -->
        {% if latest_edinet_data and latest_edinet_year %}
        <div class="latest-management-policy-section">
            <div class="section-header">
                <h2>最新の事業概要・経営方針・課題</h2>
                <p class="subsection-title">{{ latest_edinet_year }}年度有価証券報告書より{% if latest_edinet_data.submitDate %}（提出日: {{ latest_edinet_data.submitDate }}）{% endif %}</p>
            </div>
            <div class="latest-management-policy-content">
                {% if latest_edinet_data.management_policy %}
                <div class="summary-text">{{ latest_edinet_data.management_policy | format_summary_text | safe }}</div>
                {% endif %}
                
                {% if latest_edinet_data.pdf_path %}
                <div class="document-link">
                    <a href="{{ latest_edinet_data.pdf_path }}" target="_blank">有価証券報告書PDFを開く</a>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- 年度別財務データ表 -->
        {% if years %}
        <div class="financial-table-section">
            <div class="section-header">
                <h2>年度別財務データ</h2>
            </div>
            <table class="financial-table">
                <thead>
                    <tr>
                        <th>年度</th>
                        <th>年度終了日</th>
                        <th>売上高</th>
                        <th>営業利益</th>
                        <th>当期純利益</th>
                        <th>営業CF</th>
                        <th>投資CF</th>
                        <th>FCF</th>
                        <th>ROE(%)</th>
                        <th>EPS</th>
                        <th>PER</th>
                        <th>PBR</th>
                        <th>配当性向</th>
                    </tr>
                </thead>
                <tbody>
                    {% for year in years %}
                    <tr>
                        <td>{{ year.get("fiscal_year", year.get("fy_end", "") | extract_fiscal_year) }}</td>
                        <td>{{ year.get("fy_end", "N/A") }}</td>
                        <td>{% if year.get("sales") is not none %}{{ year.sales | format_currency(0) }}{% else %}N/A{% endif %}</td>
                        <td>{% if year.get("op") is not none %}{{ year.op | format_currency(0) }}{% else %}N/A{% endif %}</td>
                        <td>{% if year.get("np") is not none %}{{ year.np | format_currency(0) }}{% else %}N/A{% endif %}</td>
                        <td>{% if year.get("cfo") is not none %}{{ year.cfo | format_currency(0) }}{% else %}N/A{% endif %}</td>
                        <td>{% if year.get("cfi") is not none %}{{ year.cfi | format_currency(0) }}{% else %}N/A{% endif %}</td>
                        <td>{% if year.get("fcf") is not none %}{{ year.fcf | format_currency(0) }}{% else %}N/A{% endif %}</td>
                        <td>{% if year.get("roe") is not none %}{{ "{:.2f}".format(year.roe) }}{% else %}N/A{% endif %}</td>
                        <td>{% if year.get("eps") is not none %}{{ "{:.2f}".format(year.eps) }}{% else %}N/A{% endif %}</td>
                        <td>{% if year.get("per") is not none %}{{ "{:.2f}".format(year.per) }}{% else %}N/A{% endif %}</td>
                        <td>{% if year.get("pbr") is not none %}{{ "{:.2f}".format(year.pbr) }}{% else %}N/A{% endif %}</td>
                        <td>{% if year.get("payout_ratio") is not none %}{{ "{:.2f}".format(year.payout_ratio) }}%{% else %}N/A{% endif %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

    </div>

    <!-- Page 2: グラフ -->
    {% if graphs %}
    <div class="page page-2">
        <div class="section-header">
            <h2>財務グラフ</h2>
        </div>
        <div class="graphs-grid graphs-grid-compact">
            {% set ns = namespace(prev_section_title="", graph_count=0, business_strength_done=false, shareholder_value_done=false) %}
            {% for graph in graphs %}
                {% set ns.graph_count = ns.graph_count + 1 %}
                {% set current_section_title = graph.section_title if graph.section_title else graph.title %}
                {% if graph.section_title == "事業効率" and not ns.business_strength_done %}
                <div class="section-divider">【事業の実力】</div>
                {% set ns.business_strength_done = true %}
                {% elif graph.section_title == "株主価値の蓄積" and not ns.shareholder_value_done %}
                <div class="section-divider">【株主価値と市場評価】</div>
                {% set ns.shareholder_value_done = true %}
                {% endif %}
                <!-- 全てのグラフを1列で大きめに表示 -->
                <div class="graph-container graph-container-full">
                    {% if current_section_title != ns.prev_section_title %}
                    <h2 class="section-title">{{ current_section_title }}</h2>
                    {% endif %}
                    {% set ns.prev_section_title = current_section_title %}
                    {% if graph.title and graph.title != current_section_title %}
                    <h3 class="graph-title">{{ graph.title | safe }}</h3>
                    {% endif %}
                    {% if graph.type == "interactive" %}
                        <div class="graph-interactive">
                            {{ graph.html | safe }}
                        </div>
                    {% elif graph.image %}
                        <div class="graph-image">
                            <img src="data:image/png;base64,{{ graph.image }}" alt="{{ graph.section_title if graph.section_title else graph.title }}">
                        </div>
                    {% else %}
                        <div class="graph-fallback">
                            <p>グラフデータが利用できません</p>
                        </div>
                    {% endif %}
                    {% if graph.evaluation %}
                    <div class="evaluation-section">
                        <h4 class="evaluation-title">総合評価（{{ graph.evaluation.start_year }}-{{ graph.evaluation.end_year }}年）</h4>
                        <div class="evaluation-content">
                            <div class="evaluation-cagr">
                                {% if graph.evaluation.roic_cagr is defined and graph.evaluation.cf_conversion_cagr is defined %}
                                <!-- 事業効率用 -->
                                <div class="cagr-item">簡易ROIC CAGR: <strong>{{ "{:+.2f}".format(graph.evaluation.roic_cagr) }}%</strong> ({{ graph.evaluation.roic_sign }})</div>
                                <div class="cagr-item">CF変換率 CAGR: <strong>{{ "{:+.2f}".format(graph.evaluation.cf_conversion_cagr) }}%</strong> ({{ graph.evaluation.cf_sign }})</div>
                                {% elif graph.evaluation.eps_cagr is defined and graph.evaluation.bps_cagr is defined and graph.evaluation.roe_cagr is defined %}
                                <!-- 株主価値の蓄積用 -->
                                <div class="cagr-item">EPS CAGR: <strong>{{ "{:+.2f}".format(graph.evaluation.eps_cagr) }}%</strong> ({{ graph.evaluation.eps_sign }})</div>
                                <div class="cagr-item">BPS CAGR: <strong>{{ "{:+.2f}".format(graph.evaluation.bps_cagr) }}%</strong> ({{ graph.evaluation.bps_sign }})</div>
                                <div class="cagr-item">ROE CAGR: <strong>{{ "{:+.2f}".format(graph.evaluation.roe_cagr) }}%</strong> ({{ graph.evaluation.roe_sign }})</div>
                                {% elif graph.evaluation.roe_cagr is defined and graph.evaluation.pbr_cagr is defined and graph.evaluation.payout_cagr is defined %}
                                <!-- 配当政策と市場評価用 -->
                                <div class="cagr-item">ROE CAGR: <strong>{{ "{:+.2f}".format(graph.evaluation.roe_cagr) }}%</strong> ({{ graph.evaluation.roe_sign }})</div>
                                <div class="cagr-item">PBR CAGR: <strong>{{ "{:+.2f}".format(graph.evaluation.pbr_cagr) }}%</strong> ({{ graph.evaluation.pbr_sign }})</div>
                                <div class="cagr-item">配当性向 CAGR: <strong>{{ "{:+.2f}".format(graph.evaluation.payout_cagr) }}%</strong> ({{ graph.evaluation.payout_sign }})</div>
                                {% elif graph.evaluation.per_cagr is defined and graph.evaluation.roe_cagr is defined and graph.evaluation.pbr_cagr is defined %}
                                <!-- 市場評価用 -->
                                <div class="cagr-item">PER CAGR: <strong>{{ "{:+.2f}".format(graph.evaluation.per_cagr) }}%</strong> ({{ graph.evaluation.per_sign }})</div>
                                <div class="cagr-item">ROE CAGR: <strong>{{ "{:+.2f}".format(graph.evaluation.roe_cagr) }}%</strong> ({{ graph.evaluation.roe_sign }})</div>
                                <div class="cagr-item">PBR CAGR: <strong>{{ "{:+.2f}".format(graph.evaluation.pbr_cagr) }}%</strong> ({{ graph.evaluation.pbr_sign }})</div>
                                {% endif %}
                            </div>
                            <div class="evaluation-result">
                                <div class="pattern-info">
                                    <span class="pattern-num">{{ graph.evaluation.pattern_num }}</span>
                                    <span class="pattern-name">{{ graph.evaluation.pattern_name }}</span>
                                    <span class="evaluation-badge evaluation-{{ graph.evaluation.evaluation }}">{{ graph.evaluation.evaluation }}</span>
                                </div>
                                <div class="evaluation-note evaluation-{{ graph.evaluation.evaluation }}">{{ graph.evaluation.note }}</div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

</body>
</html>

