# プロジェクト構造とファイル説明

このドキュメントでは、J-QUANTS投資判断分析ツールのプロジェクト構造と各ファイルの役割を説明します。

## プロジェクト構造

```
jquants-analyzer/
├── src/                    # メインソースコード
│   ├── api/                # J-QUANTS API関連
│   ├── analysis/           # 分析ロジック
│   ├── report/             # レポート生成
│   ├── utils/              # ユーティリティ
│   └── config.py              # 設定管理
├── scripts/                # 実行スクリプト
├── notebooks/              # Jupyter Notebook
├── templates/              # HTMLテンプレート
├── static/                 # 静的ファイル（CSS等）
├── data/                   # データ保存先
├── reports/                # レポート出力先
└── cache/                  # キャッシュ保存先
```

---

## ディレクトリ別説明

### `src/` - メインソースコード

#### `src/api/` - J-QUANTS API関連

**`src/api/client.py`**
- **役割**: J-QUANTS APIとの通信を担当
- **主要機能**:
  - API認証（リフレッシュトークンの取得・更新）
  - 各種エンドポイントへのリクエスト送信
  - レート制限の管理
  - エラーハンドリングとリトライ処理
- **主要クラス**: `JQuantsAPIClient`

**`src/api/__init__.py`**
- APIモジュールの公開インターフェースを定義

---

#### `src/analysis/` - 分析ロジック

**`src/analysis/individual.py`**
- **役割**: 個別銘柄の詳細分析を実行
- **主要機能**:
  - 財務データの取得と整理
  - 年度別データの抽出
  - 各種財務指標の計算
  - 分析結果の統合
  - HTMLレポートデータの生成
- **主要クラス**: `IndividualAnalyzer`

**`src/analysis/calculator.py`**
- **役割**: 財務指標の計算ロジック
- **主要機能**:
  - CAGR（年平均成長率）の計算
  - ROE、EPS、PER、PBR等の計算
  - FCF（フリーキャッシュフロー）の計算
  - 各種比率の算出
- **主要関数**: `calculate_metrics_flexible()`

**`src/analysis/__init__.py`**
- 分析モジュールの公開インターフェースを定義

---

#### `src/report/` - レポート生成

**`src/report/html_report.py`**
- **役割**: HTMLレポートの生成
- **主要機能**:
  - 分析結果からHTMLレポートを生成
  - PlotlyグラフのインタラクティブHTMLへの変換
  - 総合評価の計算（事業効率、株主価値、配当政策、市場評価用）
  - CAGR（年平均成長率）の計算
  - Jinja2テンプレートを使用したレンダリング
- **主要クラス**: `HTMLReportGenerator`
- **主要関数**: 
  - `calculate_cagr()` - CAGR計算関数
  - `evaluate_business_efficiency_pattern()` - 事業効率パターン評価
  - `evaluate_shareholder_value_pattern()` - 株主価値パターン評価
  - `evaluate_dividend_policy_pattern()` - 配当政策パターン評価
  - `evaluate_market_valuation_pattern()` - 市場評価パターン評価

**`src/report/__init__.py`**
- レポートモジュールの公開インターフェースを定義

---

#### `src/utils/` - ユーティリティ

**`src/utils/cache.py`**
- **役割**: データキャッシュの管理
- **主要機能**:
  - APIレスポンスのキャッシュ保存・読み込み
  - キャッシュの有効期限管理
  - キャッシュのクリア機能
- **主要クラス**: `CacheManager`

**`src/utils/financial_data.py`**
- **役割**: 財務データの処理と変換
- **主要機能**:
  - 年度別データの抽出
  - データの整形と正規化
  - 未来の年度データの除外
  - 四半期データ抽出機能（現在は未使用）
- **主要関数**: `extract_annual_data()`

**`src/utils/sectors.py`**
- **役割**: 業種情報の管理
- **主要機能**:
  - 業種コードと名称のマッピング
  - 業種情報の取得
- **主要関数**: `get_sector_name()`

**`src/utils/watchlist.py`**
- **役割**: ウォッチリストの管理
- **主要機能**:
  - 銘柄の追加・削除
  - タグ管理
  - CSV/JSON形式でのエクスポート・インポート
- **主要クラス**: `WatchlistManager`

**`src/utils/errors.py`**
- **役割**: カスタム例外クラスの定義
- **主要クラス**: 
  - `JQuantsAPIError`: API関連のエラー
  - `AnalysisError`: 分析処理関連のエラー
  - `CacheError`: キャッシュ関連のエラー

**`src/utils/__init__.py`**
- ユーティリティモジュールの公開インターフェースを定義

---

#### `src/config.py`
- **役割**: アプリケーション設定の管理
- **主要機能**:
  - 環境変数の読み込み
  - 設定値のデフォルト値の定義
  - 設定の検証

---

### `scripts/` - 実行スクリプト

**`scripts/notebook_analysis.py`**
- **役割**: Jupyter Notebookを実行するラッパースクリプト
- **機能**: 銘柄コードを引数として受け取り、Notebookを実行
- **使用方法**: `python3 scripts/notebook_analysis.py 6501 [2802 ...]`

**`scripts/watchlist_manager.py`**
- **役割**: ウォッチリストの管理
- **機能**: 銘柄の追加・削除、タグ管理、エクスポート・インポート
- **使用方法**: `python3 scripts/watchlist_manager.py [add|remove|list|export|import] ...`

**`scripts/test_connection.py`**
- **役割**: API接続のテスト
- **機能**: J-QUANTS APIへの接続と認証をテスト

**`scripts/test_api_data.py`**
- **役割**: APIデータ取得のテスト
- **機能**: 各種エンドポイントからのデータ取得をテスト

**`scripts/test_analysis_years.py`**
- **役割**: 分析年数のテスト
- **機能**: 異なる年数での分析結果をテスト

---

### `notebooks/` - Jupyter Notebook

**`notebooks/individual_analysis_template.ipynb`**
- **役割**: 個別銘柄の詳細分析用Notebook
- **主要セクション**:
  1. 分析対象銘柄の設定
  2. データ取得と分析（年度別データのみ）
  3. ビジュアルHTMLレポート生成（プレゼンテーション品質のレポート）
- **使用方法**: Jupyter Notebookで開いて実行、または`scripts/notebook_analysis.py`から実行

---

### `templates/` - HTMLテンプレート

**`templates/report_template.html`**
- **役割**: HTMLレポートのJinja2テンプレート
- **主要セクション**:
  - ヘッダー（銘柄情報、業種・市場区分・取得年月）
  - 年度別財務データテーブル
  - 財務グラフ（Plotlyインタラクティブグラフ）
    - **【事業の実力】**
      - 事業効率（簡易ROIC × CF変換率、総合評価付き）
      - キャッシュフロー（FCF＝営業CF＋投資CF）
    - **【株主価値と市場評価】**
      - 株主価値の蓄積（EPS × BPS × ROE、総合評価付き）
      - 配当政策と市場評価（配当性向 × ROE × PBR、総合評価付き）
      - 市場評価（PER × ROE × PBR、総合評価付き）
      - 株価とEPSの乖離

---

### `static/` - 静的ファイル

**`static/css/report.css`**
- **役割**: HTMLレポートのスタイルシート
- **主要スタイル**:
  - ページレイアウト（ページ分割なし、連続表示）
  - グラフコンテナのスタイル（白背景ボックスでセクション区分け）
  - セクションタイトル・グラフタイトルのスタイル（中央揃え）
  - テーブルのスタイル
  - 総合評価セクションのスタイル（CAGR左、パターンマッピング右）
  - 評価バッジの色分け（最良、良い、注意、危険、回避、要精査、妙味）
  - 評価コメントの色付き表示（評価に応じた色分け）
  - 印刷用スタイル（ページ分割なし）

---

### その他のディレクトリ

**`reports/`**
- 生成されたHTMLレポートを保存

**`cache/`**
- APIレスポンスのキャッシュファイル（`.pkl`形式）を保存

---

## データフロー

### 個別分析の流れ

1. **`scripts/notebook_analysis.py`** または **`notebooks/individual_analysis_template.ipynb`**
   ↓
2. **`src/analysis/individual.py`** (`IndividualAnalyzer`)
   - `src/api/client.py` (`JQuantsAPIClient`) を使用してデータ取得
   - `src/utils/cache.py` (`CacheManager`) でキャッシュ管理
   ↓
3. **`src/analysis/calculator.py`** で指標計算
   ↓
4. **`src/report/html_report.py`** (`HTMLReportGenerator`) でレポート生成
   - 総合評価の計算（CAGRに基づく8パターン評価）
   - Plotlyグラフの生成
   - `templates/report_template.html` を使用
   - `static/css/report.css` でスタイリング

---

## 主要な依存関係

- **`requests`**: HTTPリクエスト
- **`pandas`**: データ処理
- **`plotly`**: グラフ生成
- **`jinja2`**: テンプレートエンジン
- **`python-dotenv`**: 環境変数管理
- **`jupyter`**: Notebook実行環境

---

## 拡張ポイント

### 新しい分析指標を追加する場合

1. **`src/analysis/calculator.py`** に計算ロジックを追加
2. **`src/report/html_report.py`** にグラフ生成ロジックを追加（必要に応じて）
3. **`templates/report_template.html`** に表示を追加

### 新しいレポート形式を追加する場合

1. **`src/report/`** に新しいレポート生成クラスを追加
2. **`templates/`** に新しいテンプレートを追加（必要に応じて）

---

## 総合評価パターン一覧

HTMLレポートでは、CAGR（年平均成長率）に基づいて各グラフの総合評価を表示します。

### グラフ1：事業効率（簡易ROIC × CF変換率）

| パターン | 簡易ROIC | CF変換率 | 状態 | 評価 | 投資視点 |
|---------|---------|---------|------|------|---------|
| ① | + | + | 質量拡大 | 最良 | 効率も質も向上 |
| ② | + | − | 効率↑質↓ | 要注意 | 短期的要因か投資増加の可能性 |
| ③ | − | + | 効率↓質↑ | 注意 | 利益効率低下だが現金創出力は確保 |
| ④ | − | − | 質量劣化 | 回避 | 効率・現金創出ともに悪化 |

### グラフ3：株主価値の蓄積（EPS × BPS × ROE）

| パターン | EPS | BPS | ROE | 状態 | 評価 | 投資視点 |
|---------|-----|-----|-----|------|------|---------|
| ① | + | + | + | 王道成長 | 最良 | 効率も規模も拡大 |
| ⑤ | + | + | − | 成長効率低下 | 危険 | 規模拡大だがROE低下。 |
| ② | + | − | + | 希薄化投資 | 要精査 | 増資や株式報酬でBPS↑、EPS希薄化。 |
| ⑦ | + | − | − | 一時益 | 一時的 | 売却益や自社株買いでEPSのみ改善。 |
| ③ | − | + | + | 高効率縮小 | 良い | 自社株買い・リストラ |
| ⑥ | − | + | − | 非効率拡張 | 悪い | 資本肥大・失敗投資 |
| ④ | − | − | + | 効率↑でも縮小 | 注意 | 事業縮小 |
| ⑧ | − | − | − | 崩壊 | 回避 | 全部悪化 |

### グラフ4：配当政策と市場評価（ROE × PBR × 配当性向）

| パターン | ROE | PBR | 配当性向 | 状態 | 評価 | 投資視点 |
|---------|-----|-----|---------|------|------|---------|
| ① | + | + | + | 理想型 | 最良 | 稼いで評価されて返す |
| ② | + | + | − | 成長投資型 | 良い | 稼いで評価、内部留保で成長 |
| ③ | + | − | + | 割安還元型 | 割安 | 稼いで返すも過小評価 |
| ④ | + | − | − | 評価されず | 割安 | 稼ぐ力はあるが市場評価低め |
| ⑤ | − | + | + | 還元で延命 | 注意 | ROE低いが配当高で市場評価は維持 |
| ⑥ | − | + | − | 謎の高評価 | 警戒 | ROE低いがPBR高。市場期待先行の可能性 |
| ⑦ | − | − | + | 悪化中還元 | 悪い | 還元強化も評価下落 |
| ⑧ | − | − | − | 全面悪化 | 回避 | 全て悪化 |

### グラフ5：市場評価（PER × ROE × PBR）

| パターン | PER | ROE | PBR | 状態 | 評価 | 投資視点 |
|---------|-----|-----|-----|------|------|---------|
| ① | + | + | + | 成長再評価 | 注意 | 実力↑ × 期待↑ |
| ② | + | + | − | 質疑義 | 要精査 | ROE改善の質に疑問 |
| ③ | + | − | + | 期待先行 | 危険 | 実力悪化でも評価↑ |
| ④ | + | − | − | 期待乖離 | 要精査 | 期待↑だが実体↓ |
| ⑤ | − | + | + | 静かな改善 | 妙味 | 実力↑なのに評価控えめ |
| ⑥ | − | + | − | 割安候補 | 妙味 | 実力↑・市場未評価 |
| ⑦ | − | − | + | 見せかけ | 危険 | 実体↓だが評価↑ |
| ⑧ | − | − | − | 崩壊 | 回避 | 全部悪化 |

---

## 注意事項

- **キャッシュ**: API呼び出しは自動的にキャッシュされます。最新データが必要な場合はキャッシュをクリアしてください。
- **レート制限**: J-QUANTS APIにはレート制限があります。大量のデータ取得時は適切な待機時間が設定されています。
- **未来の年度データ**: 現在日付より未来の年度データは自動的に除外されます。

---